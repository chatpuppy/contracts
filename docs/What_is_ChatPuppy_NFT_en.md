
# How Chatpuppy NFT works

While we make `ChatPuppy NFT`, we keep in our mind that we should solve the following problems:

* How to make the features of NFT more interesting and fun.
* How to make NFT's attributes more credible.
* How to mint NFTs more decentralized.
* How to make NFT more valuable, immutable.
* How to trade NFT easier.
* How to make NFT more versatile and connectable to third-party platforms such as `OpenSea`, `LooksRare`, etc.

To solve these problems, we adopt the `ChainLink VRF` random number oracle, which generates random attribute data(metadata) of NFTs on the blockchain by smart contracts. These metadata determine the avatar image, level and other attributes of NFTs.

This mechanism of `ChatPuppy NFT` is different from the existing popular centralized approach of having the issuer minting NFTs and then setting the Metadata artificially for each NFT, which is a decentralized, fair and trustless NFT generation solution.

The purpose of this paper is to introduce the technical solution. Programmers can design a variety of innovative NFT products by understanding the `ChatPuppy NFT`.

## 1. ChatPuppy NFT modules
`ChatPuppy NFT` consists of the following modules.

### 1.1 Mint
Anyone can pay a small amount of `ETH` for an NFT `Mystery Box`, which based on `ERC721` protocol. Before the `Mystery Box` is opened, the metadata is zero. Only after the box is unboxed, the metadata (i.e., the attribute value of the NFT) will be randomly determined.

The `Mystery Box` is a `ERC721` token(NFT), user can get the metadata by calling `tokenMetaData` function of the smart contract. After it is unboxed, you will get metadata of the NFT a value similar to `0x05460006010607060306`. This is generated on the blockchain by `ChainLink VRF`. This metadata is immutable, nobody can amend it.

Smart contract developers can define this metadata structure by themselves. The contract that defines the metadata is [ItemFactory](https://github.com/chatpuppy/contracts/blob/main/contracts/lib/ItemFactory.sol). After the contract is deployed, the developer can define NFT's properties by calling `addBoxType` and `addItem` functions.

### 1.2 Profile
![](https://tva1.sinaimg.cn/large/e6c9d24egy1h0akf1etipj223q0t4n5k.jpg)

This module is used to manage and display NFTs in the wallet.
* Display `TokenId`, image, level, experience and metadata of NFT.
* Sell NFTs.

### 1.3 Marketplace
![](https://tva1.sinaimg.cn/large/e6c9d24egy1h0akvzoke9j21qm0u07b8.jpg)

* Display `TokenId`, image, level, experience and listing price
* Buy NFTs
* Update price
* Unlist NFTs

### 1.4 Chat Dapp
As whitepaper mentioned, The NFT avatars are shown in the `ChatPuppy Dapp`, NFTs of different level and experience will have different features.

## 2. Traits of NFT

### 2.1 Traits
Each NFT has 6 traits:
* Background
* Body
* Eyes
* Fur
* Head
* Mouth

Each traits has several items of different `Rarity`, `Level`, and `Experience` properties.

Different combinations of trait's items are generated by an blockchain-based random number generator oracle. Totally up to 100,000 different ChatPuppy NFTs, each with a different `Image`, `Rarity`, `Level`, and `Experience`.

### 2.2 ChatPuppy NFT traits table

|Trait ID|Trait Name|Item ID|Item Name|Rarity|Level|Exp.|Memo|
|-:|:-|-:|:-|-:|-:|-:|-:|
|2|Background|1|Blue|28%|1|0|
|2|Background|2|Orange|23%|1|20|
|2|Background|3|Purple|19%|1|50|
|2|Background|4|Red|15%|1|85|
|2|Background|5|Green|10%|1|180|
|2|Background|6|Grey|5%|1|460|
|3|Body|1|Gakuran|33%|1|0|
|3|Body|2|Bandana|12%|1|175|
|3|Body|3|Tropical|15%|1|120|
|3|Body|4|Hoodie|14%|1|135|
|3|Body|5|Stonks|10%|1|230|
|3|Body|6|Casual|16%|1|110|
|4|Eyes|1|Normal|30%|1|0|
|4|Eyes|2|Bored|13%|1|130|
|4|Eyes|3|Laser|6%|1|400|
|4|Eyes|4|Glasses1|9%|1|235|
|4|Eyes|5|Glasses2|11%|1|170|
|4|Eyes|6|Glasses3|16%|1|90|
|4|Eyes|7|Glasses|15%|1|100|
|5|Head|1|Plumber|6%|1|530|
|5|Head|2|Halo|6.5%|1|480|
|5|Head|3|Mohawk|7%|1|440|
|5|Head|4|Rainbow|9%|1|320|
|5|Head|5|Helmet|9.5%|1|300|
|5|Head|6|Top|7.5%|1|400|
|5|Head|7|Wizard|6.5%|1|480|
|5|Head|8|Crown|2.5%|1|1420|
|5|Head|9|Pirate|4%|1|850|
|5|Head|10|Space|3.5%|1|1000|
|5|Head|11|None|38%|1|0|
|6|Fur|1|Grey|37%|1|0|
|6|Fur|2|Green|16%|1|130|
|6|Fur|3|Brown|12%|1|210|
|6|Fur|4|Gold|6%|1|520|
|6|Fur|5|Purple|13%|1|180|
|6|Fur|6|Pink|16%|1|130|
|7|Mouth|1|Bone|18%|1|70|
|7|Mouth|2|Grrrrr|31%|1|0|
|7|Mouth|3|Soother|16%|1|95|
|7|Mouth|4|Beard|15%|1|110|
|7|Mouth|5|Mask|8%|1|290|
|7|Mouth|6|Gold|12%|1|160|

Note:
* The sum of the rarity of items for each traits must be 100%.
* Experience and Rarity are roughly inversely proportional.
* We can get totally `6 * 6 * 7 * 11 * 6 * 6 = 99792` NFTs.

### 2.3 Traits on blockchain
The following script is set with traits data from above table, all data will be updated to blockchain by `web3.js` or `ethers.js`. After the traits and items data are initialized, can be update.

```
export const itemParams = [{
		boxType: 2,
		boxName: 'Background',
		itemId: 1,
		itemName: 'Blue',
		rarity: 280000,
		level: 1,
		experience: 0,
	}, {
		boxType: 2,
		boxName: 'Background',
		itemId: 2,
		itemName: 'Orange',
		rarity: 230000,
		level: 1,
		experience: 20,
	}, {
		...
	}, {
		boxType: 7,
		boxName: 'Mouth',
		itemId:  6,
		itemName: 'Gold',
		rarity:  120000,
		level:   1,
		experience: 160,
	}
];
```

Please [refer here](https://github.com/chatpuppy/contracts/blob/main/scripts/5_test_item_factory.js) to get the source code of the script

## 3. Parse the metadata
Taking metadata `05460006010607060306` as an example, according to this metadata, we can derive avatar image, level, experience value etc.

```
0546 0006 01 06 07 06 03 06
│    │    │  │  │  │  │  │
│    │    │  │  │  │  │  └——Background#6
│    │    │  │  │  │  └——Body#3
│    │    │  │  │  └——Eyes#6
│    │    │  │  └——Head#7
│    │    │  └——Fur#6
│    │    └——Mouth#1
│    └——Level=0x0006=6
└——Experience=0x0546=1350
```

Check the properties from above traits table, we can get.
|Trait|Item ID|Level|Exp|
|:-|:-|:-|:-|
|Background|6|1|460|
|Body|3|1|120|
|Eyes|6|1|90|
|Head|7|1|480|
|Fur|6|1|130|
|Mouth|1|1|70|
|sum.||6|1350|

Level is `6`, Exp is `1350`(Hex `0x0546`), avatar image is:

![](https://tva1.sinaimg.cn/large/e6c9d24egy1h0am74935lj20g80rqdht.jpg)

To secure the attributes of NFT and avoid from maliciously tampering with the attribute values, we caculate the level and experience in the smart contract and store the values on the blockchain.

## 4. Range of rarity and experience
### 4.1 Rarity

To help users understand the attributes of ChatPuppy NFTs and evaluate the value of their NFTs, here is the way of caculation of rarity.

The rarity of each NFT is the product of six traits' rarities. Taking the above metadata `05460006010607060306` as an example, we get:

|Trait|Item ID|Rarity|
|:-|:-|:-|
|Background|6|5%|
|Body|3|15%|
|Eyes|6|16%|
|Head|7|6.5%|
|Fur|6|16%|
|Mouth|1|18%|
|Probability||0.0000022464|

That means there probably `2.2464` NFT will be same in `1,000,000` NFTs. Consider we only have `99,792` NFTs, there is no possibility to get same NFT.

### 4.2 The rarest NFT
The lowest probability (the rarest) is: `0.0000000360`, that is `3.6 in one billion`, the corresponding metadata is: `0x0CF80006050408030506`

|Trait|Item ID|Rarity|Exp|
|:-|:-|:-|:-|
|Background|6|5%|460|
|Body|5|10%|230|
|Eyes|3|6%|400|
|Head|8|2.5%|1420|
|Fur|4|6%|520|
|Mouth|5|8%|290|
|Probability||0.0000000360|Exp：3320=0x0CF8|

### 4.3 Experience probability distribution
![](https://tva1.sinaimg.cn/large/e6c9d24egy1h0b22tru6aj20yy0m8dhb.jpg)

![](https://tva1.sinaimg.cn/large/e6c9d24egy1h0b29c46fnj20yy0m8gmz.jpg)

(Experience pareto distribution) 

`80%` probability is exp: `350-1300`.

### 4.4 Rarity probability distribution
![](https://tva1.sinaimg.cn/large/e6c9d24egy1h0b24e3skqj20yy0m8abl.jpg)

![](https://tva1.sinaimg.cn/large/e6c9d24egy1h0b2crmuz5j20yw0m8dh5.jpg)
(Rarity pareto distribution)

`50%` probability is `0-25`, means `0-25` same NFTs in `1,000,000`. Consider we only have `99,792` NFTs, there will be maximum 2.5 same NFTs.

## 5. On chain randome generator
The key in the implementation scheme is how to generate random numbers in the smart contract to produce metadata attributes. Thanks to `ChainLink` for providing a random number scheme based on `VRF (Verifiable Random Function)`, which allows us to generate random numbers on blockchain, thus making NFT casting more interesting and trustworthy, and truly decentralized.

Recently, `ChainLink` has launched `VRF V2`. [Refer here](https://docs.chain.link/docs/chainlink-vrf/)

If you want to know how `ChatPuppy NFT` call and implement randomness in smart contract, please refer to the smart contract on my github repo: 

[ChatPuppyNFTManagerV2.sol](https://github.com/chatpuppy/contracts/blob/main/contracts/ChatPuppyNFTManagerV2.sol)

## 6. Metadata on-chain or off-chain
Currently, the way of trading on NFT marketplace such as `OpenSea` is basically that the issuer issues thousands of NFTs, and then opens a store (Collection) on `Opensea` to put these NFTs and start selling them.

Most of the NFT metadata is not stored on the blockchain, but on the issuer's servers and save the picture on IPFS. The metadata attributes of these NFTs can be modified by the publisher. Thus there will be potentially risk.

In addition to this, many GameFi also generate random properties of NFTs on their server. This are inherently centralized, and because of this, the main approaches have been criticized and have resulted in a lack of real protection for the value of NFT assets.

The key to solving this problem is how to generate NFT properties directly on the blockchain, and we are glad to see that the `Loot` has proposed an interesting thing to solve this problem: issuer-defined NFT features. However, Loot's features are still defined by the issuer, can not avoid modifying.

`ChatPuppy NFT` provides a new solution for NFT as well as GameFi by defining feature values on blockchain through `ChainLink VRF` random number oracle.

We believe the `metadata-based NFT` will be more valuable than the picture/video NFTs soon.
